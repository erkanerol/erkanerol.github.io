<!doctype html><html class="not-ready text-sm lg:text-base" lang=en-en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title>Debugging k8s services: 3 tools for 3 scenarios - Blog</title>
<meta name=theme-color>
<meta name=description content="While developing/debugging applications that serve services on k8s in production, you need some tools/commands. This blog post explains three different scenarios+tools for you.

Please ping me if there is something wrong. https://twitter.com/erkan_erol_
">
<meta name=author content="Erkan Erol">
<link rel="preload stylesheet" as=style href=https://erkanerol.github.io/main.min.css>
<script defer src=https://erkanerol.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://erkanerol.github.io/theme.png>
<link rel=preload as=image href=https://www.gravatar.com/avatar/321108fd00753fd95baeddbc3abc8a76>
<link rel=preload as=image href=https://erkanerol.github.io/twitter.svg>
<link rel=preload as=image href=https://erkanerol.github.io/github.svg>
<link rel=preload as=image href=https://erkanerol.github.io/instagram.svg>
<link rel=preload as=image href=https://erkanerol.github.io/rss.svg>
<link rel=preload as=image href=https://erkanerol.github.io/linkedin.svg>
<link rel=icon href=https://erkanerol.github.io/favicon.ico>
<link rel=apple-touch-icon href=https://erkanerol.github.io/apple-touch-icon.png>
<meta name=generator content="Hugo 0.92.0">
<meta property="og:title" content="Debugging k8s services: 3 tools for 3 scenarios">
<meta property="og:description" content="While developing/debugging applications that serve services on k8s in production, you need some tools/commands. This blog post explains three different scenarios+tools for you.

Please ping me if there is something wrong. https://twitter.com/erkan_erol_
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://erkanerol.github.io/post/debugging-k8s-services/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-02-28T16:00:00+03:00">
<meta property="article:modified_time" content="2021-02-28T16:00:00+03:00">
<meta itemprop=name content="Debugging k8s services: 3 tools for 3 scenarios">
<meta itemprop=description content="While developing/debugging applications that serve services on k8s in production, you need some tools/commands. This blog post explains three different scenarios+tools for you.

Please ping me if there is something wrong. https://twitter.com/erkan_erol_
"><meta itemprop=datePublished content="2021-02-28T16:00:00+03:00">
<meta itemprop=dateModified content="2021-02-28T16:00:00+03:00">
<meta itemprop=wordCount content="1009">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Debugging k8s services: 3 tools for 3 scenarios">
<meta name=twitter:description content="While developing/debugging applications that serve services on k8s in production, you need some tools/commands. This blog post explains three different scenarios+tools for you.

Please ping me if there is something wrong. https://twitter.com/erkan_erol_
">
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-57796113-2','auto'),ga('send','pageview')</script>
</head>
<body class="text-black duration-200 ease-out dark:text-white">
<header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
<div class="relative z-50 mr-auto flex items-center">
<a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=https://erkanerol.github.io/>Blog</a>
<a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"></a>
</div>
<a class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>
<script>const metaTheme=document.querySelector('meta[name="theme-color"]'),htmlClass=document.documentElement.classList;setTimeout(()=>htmlClass.remove('not-ready'),10);const setDark=a=>{metaTheme.setAttribute('content',a?'#000':'#fbfbfb'),htmlClass[a?'add':'remove']('dark'),localStorage.setItem('dark',a)},darkScheme=window.matchMedia('(prefers-color-scheme: dark)'),darkVal=localStorage.getItem('dark');setDark(darkVal?darkVal==='true':darkScheme.matches),darkScheme.addEventListener('change',a=>{setDark(a.matches)});const btnDark=document.querySelector('.btn-dark');btnDark.addEventListener('click',()=>{setDark(localStorage.getItem('dark')!=='true')});const btnMenu=document.querySelector('.btn-menu');btnMenu.addEventListener('click',()=>{htmlClass.toggle('open')})</script>
<div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none">
<nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/categories/tr/>Turkish</a>
<a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/categories/en/>English</a>
</nav>
<nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6">
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/erkan_erol_ target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/erkanerol target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./instagram.svg) href=https://instagram.com/theerkanerol target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://erkanerol.github.io/index.xml target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./linkedin.svg) href=https://linkedin.com//in/erkanerol target=_blank></a>
</nav>
</div>
</header>
<main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert">
<article>
<header class=mb-20>
<h1 class="!my-0 pb-2.5">Debugging k8s services: 3 tools for 3 scenarios</h1>
<div class="text-sm opacity-60">
<time>Feb 28, 2021</time>
<span class=mx-1>&#183;</span>
<span>Erkan Erol</span>
</div>
</header>
<section><p>While developing/debugging applications that serve services on k8s in production, you need some tools/commands. This blog post explains three different scenarios+tools for you.</p>
<blockquote>
<p>Please ping me if there is something wrong. <a href=https://twitter.com/erkan_erol>https://twitter.com/erkan_erol</a>_</p>
</blockquote>
<br>
<h2 id=setup>Setup</h2>
<p>Here is our basic setup to explain the scenarios.</p>
<p><img src=/img/k8s-services/Setup.png alt=Setup></p>
<p>We have 3 services. <code>service-front</code> is exposed to the public via an ingress. <code>service-front</code> depends on <code>service-middle</code> and <code>service-middle</code> depends on <code>service-back</code>. The communications are done through k8s services.</p>
<p>To install this setup, here are the necessary commands:</p>
<pre tabindex=0><code>kubectl create ns service-debug
kubectl -n service-debug run service-back --image=erkanerol/service-back:v1 --port=8080 --expose=true --labels=&quot;app=back&quot;
kubectl -n service-debug run service-middle --image=erkanerol/service-middle:v1 --port=8081 --expose=true --labels=&quot;app=middle&quot;
kubectl -n service-debug run service-front --image=erkanerol/service-front:v1 --port=8082 --expose=true --labels=&quot;app=front&quot;
</code></pre><p>Here is the source code of these services: <a href=https://github.com/erkanerol/service-examples-for-blog>https://github.com/erkanerol/service-examples-for-blog</a></p>
<p><br><br></p>
<h2 id=tool-1-kubectl-port-forward>Tool 1: <code>kubectl port-forward</code></h2>
<h4 id=scenario>Scenario:</h4>
<p>As a developer, I want to send some requests to <code>service-back</code> directly and see the result without touching the other services.</p>
<h4 id=problem>Problem:</h4>
<p><code>service-back</code> is not exposed to the public and you cannot send requests to it directly.</p>
<h4 id=solution>Solution:</h4>
<p>With <code>kubectl port-forward</code>, it is possible to open a tunnel from your local machine to the <code>service-back</code> in the cluster. See <a href=https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#port-forward>https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#port-forward</a></p>
<h4 id=steps>Steps:</h4>
<p>Run the command below in a terminal.</p>
<pre tabindex=0><code>$ kubectl -n service-debug port-forward service/service-back 8080:8080
Forwarding from 127.0.0.1:8080 -&gt; 8080
Forwarding from [::1]:8080 -&gt; 8080
</code></pre><br>
Then run the curl command below in another terminal to see that you are able to access `service-back`
<pre tabindex=0><code>$ curl localhost:8080
Timestamp from back:1614508193
</code></pre><br>
<h4 id=how-does-it-work>How does it work?</h4>
<p><img src=/img/k8s-services/Level1.png alt=Level1></p>
<p><code>kubectl</code> starts a process which binds <code>localhost:8080</code>. It listens that port and establishes a connection to api-server, which forwards the requests to <code>service-back</code>.</p>
<p><br><br></p>
<h2 id=tool-2-kubefwd>Tool 2: <code>kubefwd</code></h2>
<h4 id=scenario-1>Scenario:</h4>
<p>As a developer, I want to run <code>service-front</code> in my local machine so that I can put breakpoints in my IDE to debug my application.</p>
<h4 id=problem-1>Problem:</h4>
<p><code>service-front</code> is designed to run in Kubernetes and it accesses <code>service-middle</code> via the k8s service. The service name is hardcoded or hard to be configurable or you are too lazy to mock the dependencies in your local machine.</p>
<h4 id=solution-1>Solution:</h4>
<p><code>kubefwd</code> is a useful tool for this problem. It does bulk port-forwarding and manages dns entries in your local machine. See <a href=https://github.com/txn2/kubefwd>https://github.com/txn2/kubefwd</a></p>
<h4 id=steps-1>Steps:</h4>
<p>Run the command below in a terminal</p>
<pre tabindex=0><code>$ sudo KUBECONFIG=$KUBECONFIG kubefwd svc -n service-debug -l app=middle
</code></pre><blockquote>
<p>Note that <code>kubefwd</code> requires root privileges and it has to be run with <code>sudo</code>. Set <code>KUBECONFIG</code> variable without any home folder reference beforehand.</p>
</blockquote>
<br>
<p>In another terminal, run <code>front</code> application in your local machine. Note that you can run it in debug mode as well and put breakpoints.</p>
<pre tabindex=0><code>$ cd /tmp
$ git clone https://github.com/erkanerol/service-examples-for-blog.git
$ cd service-examples-for-blog/front
$ go run main.go
</code></pre><br>
<p>In another terminal, Send a request to <code>front</code> app to see that your front app serves locally and it accesses <code>service-middle</code> in the cluster.</p>
<pre tabindex=0><code>$ curl localhost:8082
Response from service middle:'Response from service back:'Timestamp from back:1614513901''
</code></pre><br>
<h4 id=how-does-it-work-1>How does it work?</h4>
<p><img src=/img/k8s-services/Level2.png alt=Level2></p>
<p>As you can see from the logs of <code>kubefwd</code></p>
<pre tabindex=0><code>...
INFO[14:07:38] 'cat /etc/hosts' to see all host entries.    
INFO[14:07:38] Loaded hosts file /etc/hosts                 
INFO[14:07:38] HostFile management: Original hosts backup already exists at /root/hosts.original 
...
INFO[14:07:38] Port-Forward: 127.1.27.1 service-middle:8081 to pod service-middle:8081 
...
</code></pre><br>
<p>It starts a process that binds <code>127.1.27.1:8081</code> and manipulates the <code>/etc/hosts</code> for <code>service-middle</code></p>
<pre tabindex=0><code>$ cat /etc/hosts |grep service-middle
127.1.27.1       service-middle.default service-middle.default.svc service-middle.default.svc.cluster.local service-middle.default.minikube service-middle.default.svc.minikube service-middle.default.svc.cluster.minikube service-middle service-middle.service-debug service-middle.service-debug.svc service-middle.service-debug.svc.cluster.local service-middle.service-debug.minikube service-middle.service-debug.svc.minikube service-middle.service-debug.svc.cluster.minikube
</code></pre><p>Then your local <code>front</code> app can access the <code>service-middle</code> like in k8s cluster without any extra effort.
<br><br></p>
<h2 id=tool-3-telepresence>Tool 3: <code>telepresence</code></h2>
<h4 id=scenario-2>Scenario:</h4>
<p>As a developer, I want to run <code>service-middle</code> in my local machine so that I can put breakpoints in my IDE to debug my application.</p>
<h4 id=problem-2>Problem:</h4>
<p><code>service-middle</code> is designed to run in Kubernetes. It accesses <code>service-back</code> via k8s services. Also, its consumer <code>service-front</code> is running on k8s. The services are not available in your local machine and it is hard to mock all these environments in your local machine.</p>
<h4 id=solution-2>Solution:</h4>
<p><code>telepresence</code> is a useful tool for this problem. See <a href=https://www.telepresence.io/>https://www.telepresence.io/</a></p>
<h4 id=steps-2>Steps:</h4>
<p>Delete <code>service-middle</code> from your k8s cluster at first. We will run it locally.</p>
<pre tabindex=0><code>kubectl -n service-debug delete service service-middle --ignore-not-found=true
kubectl -n service-debug delete pod service-middle --ignore-not-found=true
</code></pre><br>
Run telepresence for `service-middle`
```
telepresence --namespace service-debug --new-deployment service-middle --expose 8081
```
<br>
In another terminal, run `middle` application in your local machine. Note that you can run it in debug mode as well and put breakpoints.
<pre tabindex=0><code>$ cd /tmp
$ git clone https://github.com/erkanerol/service-examples-for-blog.git
$ cd service-examples-for-blog/middle
$ go run main.go
</code></pre><br>
In another terminal, run the command below to send a request to `service-front` via a temporary pod in the cluster.
```
$ kubectl -n service-debug run curl -it --rm=true --image=curlimages/curl --restart=Never -- http://service-front:8082
Response from service middle:'Response from service back:'Timestamp from back:1614517363''pod "curl" deleted
```
<p>Note that your request goes to <code>service-front</code> in k8s, which sends a request to <code>service-middle</code> in your local machine, which sends a request to <code>service-back</code> in the cluster.</p>
<br>
<h4 id=how-does-it-work-2>How does it work?</h4>
<p><img src=/img/k8s-services/Level3.png alt=Level3></p>
<p>Basically, <code>telepresence</code> deploys a proxy/fake agent into cluster and opens a two-way tunnel between your local environment and the cluster via that agent. Then you are able to run the <code>middle</code> service in your local machine without adapting the consumers/dependent services.</p>
<p>A detailed explanation about how telepresence works is available here: <a href=https://www.telepresence.io/discussion/how-it-works>https://www.telepresence.io/discussion/how-it-works</a></p>
<br>
<h2 id=summary>Summary</h2>
<ul>
<li>If you need to access a service without exposing it to public, <code>kubectl port-forward</code> is enough.</li>
<li>If you need to run a service locally for debugging and your service needs to access other services on k8s, <code>kubefwd</code> is enough. It manages DNS entries in your local machine and opens a one-way tunnel from your machine to cluster for the dependencies of your service.</li>
<li>If you need to run a service locally for debugging and your application has some consumers in the cluster, <code>telepresence</code> is your tool. It opens two-way network channel and it forwards requests from cluster to your local instance as well.</li>
</ul>
<p><br><br></p>
<p>p.s. Admission webhooks in Kubernetes are similar to <code>service-middle</code>. They receive some requests from api-server and they may send some requests to other services in the cluster. Therefore, <code>telepresence</code> is a useful tool for debugging admission webhooks. In the next blog post, I am going to explain how to debug validating webhooks.</p></section>
<nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
<a class="flex w-1/2 items-center p-6 pr-3 no-underline" href=https://erkanerol.github.io/post/complexity-of-kubernetes/><span class=mr-1.5>←</span><span>Thinking about the complexity of the Kubernetes ecosystem</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline" href=https://erkanerol.github.io/post/basics-of-container-runtimes/><span>Learning Path: Basics of Container Runtimes</span><span class=ml-1.5>→</span></a>
</nav>
</article>
</main>
<footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60">
<div class=mr-auto>
&copy; 2022
<a class=link href=https://erkanerol.github.io/>Blog</a>
</div>
<a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>▷ Paper 6</a>
</footer>
</body>
</html>